{
  "info": {
    "name": "ğŸ” Login Collection - Project EQU",
    "description": "ColecciÃ³n simple para probar el login de los tres usuarios del sistema: Admin, TÃ©cnico y Supervisor",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:3001",
      "type": "string"
    },
    {
      "key": "admin_token",
      "value": "",
      "type": "string"
    },
    {
      "key": "tecnico_token",
      "value": "",
      "type": "string"
    },
    {
      "key": "supervisor_token",
      "value": "",
      "type": "string"
    },
    {
      "key": "tecnico_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "trabajo_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "trabajo_creado_id",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "ğŸ” Login - Admin",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"admin1@demo.com\",\n  \"password\": \"123456\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/auth/login",
          "host": ["{{base_url}}"],
          "path": ["auth", "login"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    if (response.access_token) {",
              "        pm.collectionVariables.set('admin_token', response.access_token);",
              "        console.log('âœ… Token Admin guardado:', response.access_token.substring(0, 50) + '...');",
              "        console.log('ğŸ‘¤ Usuario:', response.user.name);",
              "        console.log('ğŸ“§ Email:', response.user.email);",
              "    }",
              "} else {",
              "    console.log('âŒ Error en login Admin:', pm.response.status);",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "ğŸ” Login - TÃ©cnico",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"tecnico1@demo.com\",\n  \"password\": \"123456\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/auth/login",
          "host": ["{{base_url}}"],
          "path": ["auth", "login"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
                            "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    if (response.access_token) {",
                  "        pm.collectionVariables.set('tecnico_token', response.access_token);",
                  "        console.log('âœ… Token TÃ©cnico guardado:', response.access_token.substring(0, 50) + '...');",
                  "        console.log('ğŸ‘¤ Usuario:', response.user.name);",
                  "        console.log('ğŸ“§ Email:', response.user.email);",
                  "    }",
                  "    if (response.user && response.user.id) {",
                  "        pm.collectionVariables.set('tecnico_id', response.user.id);",
                  "        console.log('ğŸ’¾ ID TÃ©cnico guardado:', response.user.id);",
                  "        console.log('ğŸ” Verificando UUID:', response.user.id);",
                  "    }",
                  "} else {",
                  "    console.log('âŒ Error en login TÃ©cnico:', pm.response.status);",
                  "}"
            ]
          }
        }
      ]
    },
    {
      "name": "ğŸ” Login - Supervisor",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"supervisor1@demo.com\",\n  \"password\": \"123456\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/auth/login",
          "host": ["{{base_url}}"],
          "path": ["auth", "login"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    if (response.access_token) {",
              "        pm.collectionVariables.set('supervisor_token', response.access_token);",
              "        console.log('âœ… Token Supervisor guardado:', response.access_token.substring(0, 50) + '...');",
              "        console.log('ğŸ‘¤ Usuario:', response.user.name);",
              "        console.log('ğŸ“§ Email:', response.user.email);",
              "    }",
              "} else {",
              "    console.log('âŒ Error en login Supervisor:', pm.response.status);",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "ğŸ”„ Login Todos los Usuarios",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"admin1@demo.com\",\n  \"password\": \"123456\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/auth/login",
          "host": ["{{base_url}}"],
          "path": ["auth", "login"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "// Script para hacer login de todos los usuarios secuencialmente",
              "console.log('ğŸš€ Iniciando login de todos los usuarios...');",
              "",
              "// FunciÃ³n para hacer login",
              "function loginUser(email, password, tokenVar) {",
              "    return new Promise((resolve) => {",
              "        pm.sendRequest({",
              "            url: pm.collectionVariables.get('base_url') + '/auth/login',",
              "            method: 'POST',",
              "            header: {",
              "                'Content-Type': 'application/json'",
              "            },",
              "            body: {",
              "                mode: 'raw',",
              "                raw: JSON.stringify({ email: email, password: password })",
              "            }",
              "        }, function (err, response) {",
              "            if (err) {",
              "                console.log('âŒ Error en login ' + email + ':', err);",
              "                resolve(false);",
              "            } else if (response.code === 200) {",
              "                const data = response.json();",
              "                pm.collectionVariables.set(tokenVar, data.access_token);",
              "                console.log('âœ… Login exitoso ' + email + ':', data.user.name);",
              "                resolve(true);",
              "            } else {",
              "                console.log('âŒ Error en login ' + email + ':', response.status);",
              "                resolve(false);",
              "            }",
              "        });",
              "    });",
              "}",
              "",
              "// Ejecutar logins secuencialmente",
              "setTimeout(async () => {",
              "    const adminResult = await loginUser('admin1@demo.com', '123456', 'admin_token');",
              "    const tecnicoResult = await loginUser('tecnico1@demo.com', '123456', 'tecnico_token');",
              "    const supervisorResult = await loginUser('supervisor1@demo.com', '123456', 'supervisor_token');",
              "    ",
              "    console.log('ğŸ“Š Resumen de logins:');",
              "    console.log('   Admin:', adminResult ? 'âœ…' : 'âŒ');",
              "    console.log('   TÃ©cnico:', tecnicoResult ? 'âœ…' : 'âŒ');",
              "    console.log('   Supervisor:', supervisorResult ? 'âœ…' : 'âŒ');",
              "    ",
              "    if (adminResult && tecnicoResult && supervisorResult) {",
              "        console.log('ğŸ‰ Â¡Todos los logins exitosos!');",
              "    } else {",
              "        console.log('âš ï¸ Algunos logins fallaron');",
              "    }",
              "}, 1000);"
            ]
          }
        }
      ]
    },
    {
      "name": "ğŸ“‹ InformaciÃ³n de Usuarios",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/users",
          "host": ["{{base_url}}"],
          "path": ["users"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    console.log('ğŸ“‹ Usuarios disponibles en el sistema:');",
              "    response.data.forEach(user => {",
              "        console.log('   ğŸ‘¤ ' + user.name + ' (' + user.email + ')');",
              "    });",
              "} else {",
              "    console.log('âŒ Error al obtener usuarios:', pm.response.status);",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "ğŸ—ï¸ GestiÃ³n de Trabajos",
      "item": [
        {
          "name": "â• Crear Trabajo - Supervisor",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{supervisor_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"titulo\": \"InstalaciÃ³n de lÃ­nea elÃ©ctrica en sector norte\",\n  \"descripcion\": \"InstalaciÃ³n completa de lÃ­nea elÃ©ctrica de media tensiÃ³n en el sector norte de la ciudad. Incluye montaje de postes, tendido de cables y conexiones.\",\n  \"observacion\": \"Requiere coordinaciÃ³n con el municipio y cierre de calles temporales\",\n  \"imagenes\": [\n    \"https://ejemplo.com/imagen1.jpg\",\n    \"https://ejemplo.com/imagen2.jpg\"\n  ],\n  \"tecnicoAsignadoId\": \"{{tecnico_id}}\",\n  \"estado\": \"pendiente\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/trabajos",
              "host": ["{{base_url}}"],
              "path": ["trabajos"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    const response = pm.response.json();",
                  "    console.log('âœ… Trabajo creado exitosamente:');",
                  "    console.log('   ğŸ†” ID:', response.id);",
                  "    console.log('   ğŸ“‹ TÃ­tulo:', response.titulo);",
                  "    console.log('   ğŸ‘¤ TÃ©cnico asignado:', response.tecnicoAsignado?.name || 'No asignado');",
                  "    console.log('   ğŸ“Š Estado:', response.estado);",
                  "    console.log('   ğŸ” Permisos creados:', response.permisos?.length || 0);",
                  "    ",
                  "    // Guardar el ID del trabajo para uso posterior",
                  "    if (response.id) {",
                  "        pm.collectionVariables.set('trabajo_id', response.id);",
                  "        console.log('ğŸ’¾ ID del trabajo guardado en variable: trabajo_id');",
                  "    }",
                  "    ",
                  "    // Guardar IDs de permisos si existen",
                  "    if (response.permisos && response.permisos.length > 0) {",
                  "        response.permisos.forEach((permiso, index) => {",
                  "            pm.collectionVariables.set('permiso_' + (index + 1) + '_id', permiso.id);",
                  "            console.log('ğŸ’¾ Permiso ' + (index + 1) + ' ID guardado:', permiso.id);",
                  "        });",
                  "    }",
                  "} else {",
                  "    console.log('âŒ Error al crear trabajo:', pm.response.status);",
                  "    console.log('ğŸ“„ Respuesta:', pm.response.text());",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "ğŸ“‹ Listar Todos los Trabajos",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/trabajos",
              "host": ["{{base_url}}"],
              "path": ["trabajos"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    console.log('ğŸ“‹ Trabajos disponibles en el sistema:');",
                  "    console.log('   ğŸ“Š Total de trabajos:', response.length || 0);",
                  "    ",
                  "    if (response && response.length > 0) {",
                  "        response.forEach((trabajo, index) => {",
                  "            console.log('   ' + (index + 1) + '. ğŸ“‹ ' + trabajo.titulo);",
                  "            console.log('      ğŸ†” ID:', trabajo.id);",
                  "            console.log('      ğŸ‘¤ TÃ©cnico:', trabajo.tecnicoAsignado?.name || 'No asignado');",
                  "            console.log('      ğŸ“Š Estado:', trabajo.estado);",
                  "            console.log('      ğŸ” Permisos:', trabajo.permisos?.length || 0);",
                  "            console.log('');",
                  "        });",
                  "    }",
                  "} else {",
                  "    console.log('âŒ Error al obtener trabajos:', pm.response.status);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "ğŸ‘ï¸ Obtener Trabajo por ID",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/trabajos/{{trabajo_id}}",
              "host": ["{{base_url}}"],
              "path": ["trabajos", "{{trabajo_id}}"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const trabajo = pm.response.json();",
                  "    console.log('ğŸ‘ï¸ Detalles del trabajo:');",
                  "    console.log('   ğŸ“‹ TÃ­tulo:', trabajo.titulo);",
                  "    console.log('   ğŸ“ DescripciÃ³n:', trabajo.descripcion);",
                  "    console.log('   ğŸ‘¤ TÃ©cnico asignado:', trabajo.tecnicoAsignado?.name || 'No asignado');",
                  "    console.log('   ğŸ“Š Estado:', trabajo.estado);",
                  "    console.log('   ğŸ“… Fecha creaciÃ³n:', trabajo.fechaCreacion);",
                  "    console.log('   ğŸ” Permisos asociados:', trabajo.permisos?.length || 0);",
                  "    ",
                  "    if (trabajo.permisos && trabajo.permisos.length > 0) {",
                  "        console.log('   ğŸ“‹ Detalles de permisos:');",
                  "        trabajo.permisos.forEach((permiso, index) => {",
                  "            console.log('      ' + (index + 1) + '. Tipo:', permiso.tipoPermiso?.nombre);",
                  "            console.log('         Estado:', permiso.estado);",
                  "            console.log('         ID:', permiso.id);",
                  "        });",
                  "    }",
                  "} else {",
                  "    console.log('âŒ Error al obtener trabajo:', pm.response.status);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "ğŸ‘¤ Mis Trabajos - TÃ©cnico",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{tecnico_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/trabajos/mis-trabajos",
              "host": ["{{base_url}}"],
              "path": ["trabajos", "mis-trabajos"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    console.log('ğŸ‘¤ Mis trabajos asignados:');",
                  "    console.log('   ğŸ“Š Total de trabajos:', response.length || 0);",
                  "    ",
                  "    if (response && response.length > 0) {",
                  "        response.forEach((trabajo, index) => {",
                  "            console.log('   ' + (index + 1) + '. ğŸ“‹ ' + trabajo.titulo);",
                  "            console.log('      ğŸ†” ID:', trabajo.id);",
                  "            console.log('      ğŸ“Š Estado:', trabajo.estado);",
                  "            console.log('      ğŸ” Permisos pendientes:', trabajo.permisos?.filter(p => p.estado === 'pendiente').length || 0);",
                  "        });",
                  "    } else {",
                  "        console.log('   ğŸ“­ No tienes trabajos asignados');",
                  "    }",
                  "} else {",
                  "    console.log('âŒ Error al obtener mis trabajos:', pm.response.status);",
                  "}"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "ğŸ”„ Flujo Completo - Supervisor Crea Trabajo",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{supervisor_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"titulo\": \"Mantenimiento de transformador en sector sur\",\n  \"descripcion\": \"Mantenimiento preventivo del transformador principal en el sector sur de la ciudad. Incluye limpieza, revisiÃ³n de conexiones y pruebas de funcionamiento.\",\n  \"observacion\": \"Trabajo programado para horario de menor demanda\",\n  \"estado\": \"pendiente\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/trabajos",
          "host": ["{{base_url}}"],
          "path": ["trabajos"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "console.log('ğŸš€ Iniciando flujo completo: Supervisor crea trabajo...');",
              "",
              "if (pm.response.code === 201) {",
              "    const trabajo = pm.response.json();",
              "    console.log('âœ… Trabajo creado exitosamente por el supervisor');",
              "    console.log('   ğŸ“‹ TÃ­tulo:', trabajo.titulo);",
              "    console.log('   ğŸ†” ID:', trabajo.id);",
              "    console.log('   ğŸ‘¤ TÃ©cnico asignado:', trabajo.tecnicoAsignado?.name || 'No asignado');",
              "    console.log('   ğŸ“Š Estado:', trabajo.estado);",
              "    console.log('   ğŸ” Permisos automÃ¡ticos creados:', trabajo.permisos?.length || 0);",
              "    ",
              "    // Guardar ID del trabajo",
              "    pm.collectionVariables.set('trabajo_creado_id', trabajo.id);",
              "    ",
              "    // Mostrar detalles de permisos",
              "    if (trabajo.permisos && trabajo.permisos.length > 0) {",
              "        console.log('   ğŸ“‹ Permisos creados automÃ¡ticamente:');",
              "        trabajo.permisos.forEach((permiso, index) => {",
              "            console.log('      ' + (index + 1) + '. ' + permiso.tipoPermiso?.nombre + ' - ' + permiso.estado);",
              "        });",
              "    }",
              "    ",
              "    console.log('ğŸ‰ Flujo completado exitosamente');",
              "    console.log('ğŸ’¡ El tÃ©cnico ahora puede ver este trabajo en \"Mis Trabajos\"');",
              "    ",
              "} else {",
              "    console.log('âŒ Error en el flujo:', pm.response.status);",
              "    console.log('ğŸ“„ Respuesta:', pm.response.text());",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "â• Crear Trabajo con TÃ©cnico - Supervisor",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{supervisor_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"titulo\": \"ReparaciÃ³n de lÃ­nea elÃ©ctrica en sector este\",\n  \"descripcion\": \"ReparaciÃ³n de lÃ­nea elÃ©ctrica daÃ±ada por tormenta en el sector este. Incluye reemplazo de cables y postes afectados.\",\n  \"observacion\": \"Trabajo de emergencia - prioridad alta\",\n  \"tecnicoAsignadoId\": \"{{tecnico_id}}\",\n  \"estado\": \"pendiente\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/trabajos",
          "host": ["{{base_url}}"],
          "path": ["trabajos"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "console.log('ğŸ” Verificando ID del tÃ©cnico:', pm.collectionVariables.get('tecnico_id'));",
              "console.log('ğŸ” Verificando token del supervisor:', pm.collectionVariables.get('supervisor_token').substring(0, 50) + '...');",
              "",
              "if (pm.response.code === 201) {",
              "    const trabajo = pm.response.json();",
              "    console.log('âœ… Trabajo creado exitosamente con tÃ©cnico asignado:');",
              "    console.log('   ğŸ“‹ TÃ­tulo:', trabajo.titulo);",
              "    console.log('   ğŸ†” ID:', trabajo.id);",
              "    console.log('   ğŸ‘¤ TÃ©cnico asignado:', trabajo.tecnicoAsignado?.name || 'No asignado');",
              "    console.log('   ğŸ“Š Estado:', trabajo.estado);",
              "    console.log('   ğŸ” Permisos creados:', trabajo.permisos?.length || 0);",
              "    ",
              "    // Guardar ID del trabajo",
              "    pm.collectionVariables.set('trabajo_con_tecnico_id', trabajo.id);",
              "    ",
              "    // Mostrar detalles de permisos",
              "    if (trabajo.permisos && trabajo.permisos.length > 0) {",
              "        console.log('   ğŸ“‹ Permisos creados automÃ¡ticamente:');",
              "        trabajo.permisos.forEach((permiso, index) => {",
              "            console.log('      ' + (index + 1) + '. ' + permiso.tipoPermiso?.nombre + ' - ' + permiso.estado);",
              "        });",
              "    }",
              "    ",
              "} else {",
              "    console.log('âŒ Error al crear trabajo:', pm.response.status);",
              "    console.log('ğŸ“„ Respuesta:', pm.response.text());",
              "    console.log('ğŸ” Body enviado:', pm.request.body.raw);",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "ğŸ” Obtener ID del TÃ©cnico",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/users",
          "host": ["{{base_url}}"],
          "path": ["users"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    const tecnico = response.data.find(user => user.email === 'tecnico1@demo.com');",
              "    ",
              "    if (tecnico) {",
              "        pm.collectionVariables.set('tecnico_id', tecnico.id);",
              "        console.log('âœ… ID del tÃ©cnico obtenido y guardado:');",
              "        console.log('   ğŸ‘¤ Nombre:', tecnico.name);",
              "        console.log('   ğŸ“§ Email:', tecnico.email);",
              "        console.log('   ğŸ†” ID:', tecnico.id);",
              "        console.log('ğŸ’¾ ID guardado en variable: tecnico_id');",
              "    } else {",
              "        console.log('âŒ No se encontrÃ³ el tÃ©cnico en la lista de usuarios');",
              "    }",
              "} else {",
              "    console.log('âŒ Error al obtener usuarios:', pm.response.status);",
              "}"
            ]
          }
        }
      ]
    }
  ]
} 