{
  "info": {
    "name": "ğŸ‘¨â€ğŸ’¼ Supervisor Crea Trabajo",
    "description": "ColecciÃ³n simple para que el supervisor cree un trabajo y se asigne a un tÃ©cnico",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:3001",
      "type": "string"
    },
    {
      "key": "supervisor_token",
      "value": "",
      "type": "string"
    },
    {
      "key": "tecnico_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "trabajo_id",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "ğŸ” Login Supervisor",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"supervisor1@demo.com\",\n  \"password\": \"123456\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/auth/login",
          "host": ["{{base_url}}"],
          "path": ["auth", "login"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    if (response.access_token) {",
              "        pm.collectionVariables.set('supervisor_token', response.access_token);",
              "        console.log('âœ… Token Supervisor guardado:', response.access_token.substring(0, 50) + '...');",
              "        console.log('ğŸ‘¤ Usuario:', response.user.name);",
              "        console.log('ğŸ“§ Email:', response.user.email);",
              "    }",
              "} else {",
              "    console.log('âŒ Error en login Supervisor:', pm.response.status);",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "ğŸ” Obtener ID del TÃ©cnico",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/users",
          "host": ["{{base_url}}"],
          "path": ["users"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    const tecnico = response.data.find(user => user.email === 'tecnico1@demo.com');",
              "    ",
              "    if (tecnico) {",
              "        pm.collectionVariables.set('tecnico_id', tecnico.id);",
              "        console.log('âœ… ID del tÃ©cnico obtenido:');",
              "        console.log('   ğŸ‘¤ Nombre:', tecnico.name);",
              "        console.log('   ğŸ“§ Email:', tecnico.email);",
              "        console.log('   ğŸ†” ID:', tecnico.id);",
              "    } else {",
              "        console.log('âŒ No se encontrÃ³ el tÃ©cnico');",
              "    }",
              "} else {",
              "    console.log('âŒ Error al obtener usuarios:', pm.response.status);",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "â• Crear Trabajo - Supervisor",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{supervisor_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"titulo\": \"InstalaciÃ³n de lÃ­nea elÃ©ctrica en sector norte\",\n  \"descripcion\": \"InstalaciÃ³n completa de lÃ­nea elÃ©ctrica de media tensiÃ³n en el sector norte de la ciudad. Incluye montaje de postes, tendido de cables y conexiones.\",\n  \"observacion\": \"Requiere coordinaciÃ³n con el municipio y cierre de calles temporales\",\n  \"tecnicoAsignadoId\": \"{{tecnico_id}}\",\n  \"estado\": \"pendiente\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/trabajos",
          "host": ["{{base_url}}"],
          "path": ["trabajos"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "console.log('ğŸ” Verificando datos:');",
              "console.log('   Token Supervisor:', pm.collectionVariables.get('supervisor_token').substring(0, 50) + '...');",
              "console.log('   ID TÃ©cnico:', pm.collectionVariables.get('tecnico_id'));",
              "",
              "if (pm.response.code === 201) {",
              "    const trabajo = pm.response.json();",
              "    console.log('âœ… Trabajo creado exitosamente:');",
              "    console.log('   ğŸ“‹ TÃ­tulo:', trabajo.titulo);",
              "    console.log('   ğŸ†” ID:', trabajo.id);",
              "    console.log('   ğŸ‘¤ TÃ©cnico asignado:', trabajo.tecnicoAsignado?.name || 'No asignado');",
              "    console.log('   ğŸ“Š Estado:', trabajo.estado);",
              "    console.log('   ğŸ” Permisos creados:', trabajo.permisos?.length || 0);",
              "    ",
              "    // Guardar ID del trabajo",
              "    pm.collectionVariables.set('trabajo_id', trabajo.id);",
              "    ",
              "    // Mostrar detalles de permisos",
              "    if (trabajo.permisos && trabajo.permisos.length > 0) {",
              "        console.log('   ğŸ“‹ Permisos creados automÃ¡ticamente:');",
              "        trabajo.permisos.forEach((permiso, index) => {",
              "            console.log('      ' + (index + 1) + '. ' + permiso.tipoPermiso?.nombre + ' - ' + permiso.estado);",
              "        });",
              "    }",
              "    ",
              "    console.log('ğŸ‰ Â¡Trabajo creado y asignado exitosamente!');",
              "    ",
              "} else {",
              "    console.log('âŒ Error al crear trabajo:', pm.response.status);",
              "    console.log('ğŸ“„ Respuesta:', pm.response.text());",
              "    console.log('ğŸ” Body enviado:', pm.request.body.raw);",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "ğŸ“‹ Ver Trabajo Creado",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/trabajos/{{trabajo_id}}",
          "host": ["{{base_url}}"],
          "path": ["trabajos", "{{trabajo_id}}"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const trabajo = pm.response.json();",
              "    console.log('ğŸ‘ï¸ Detalles del trabajo creado:');",
              "    console.log('   ğŸ“‹ TÃ­tulo:', trabajo.titulo);",
              "    console.log('   ğŸ“ DescripciÃ³n:', trabajo.descripcion);",
              "    console.log('   ğŸ‘¤ TÃ©cnico asignado:', trabajo.tecnicoAsignado?.name || 'No asignado');",
              "    console.log('   ğŸ“Š Estado:', trabajo.estado);",
              "    console.log('   ğŸ“… Fecha creaciÃ³n:', trabajo.fechaCreacion);",
              "    console.log('   ğŸ” Permisos asociados:', trabajo.permisos?.length || 0);",
              "    ",
              "    if (trabajo.permisos && trabajo.permisos.length > 0) {",
              "        console.log('   ğŸ“‹ Detalles de permisos:');",
              "        trabajo.permisos.forEach((permiso, index) => {",
              "            console.log('      ' + (index + 1) + '. Tipo:', permiso.tipoPermiso?.nombre);",
              "            console.log('         Estado:', permiso.estado);",
              "            console.log('         ID:', permiso.id);",
              "        });",
              "    }",
              "} else {",
              "    console.log('âŒ Error al obtener trabajo:', pm.response.status);",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "ğŸ“Š Listar Todos los Trabajos",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/trabajos",
          "host": ["{{base_url}}"],
          "path": ["trabajos"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    console.log('ğŸ“‹ Trabajos disponibles en el sistema:');",
              "    console.log('   ğŸ“Š Total de trabajos:', response.length || 0);",
              "    ",
              "    if (response && response.length > 0) {",
              "        response.forEach((trabajo, index) => {",
              "            console.log('   ' + (index + 1) + '. ğŸ“‹ ' + trabajo.titulo);",
              "            console.log('      ğŸ†” ID:', trabajo.id);",
              "            console.log('      ğŸ‘¤ TÃ©cnico:', trabajo.tecnicoAsignado?.name || 'No asignado');",
              "            console.log('      ğŸ“Š Estado:', trabajo.estado);",
              "            console.log('      ğŸ” Permisos:', trabajo.permisos?.length || 0);",
              "            console.log('');",
              "        });",
              "    }",
              "} else {",
              "    console.log('âŒ Error al obtener trabajos:', pm.response.status);",
              "}"
            ]
          }
        }
      ]
    }
  ]
} 